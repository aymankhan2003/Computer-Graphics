const compileShader=(a,b,d)=>{let c=a.createShader(d);a.shaderSource(c,b);a.compileShader(c);if(!a.getShaderParameter(c,a.COMPILE_STATUS))throw b=a.getShaderInfoLog(c),a.deleteShader(c),"Unable to compile "+(d===a.VERTEX_SHADER?"vertex":"fragment")+" shader: "+b;return c},compileProgram=(a,b,d)=>{b=compileShader(a,b,a.VERTEX_SHADER);d=compileShader(a,d,a.FRAGMENT_SHADER);let c=a.createProgram();a.attachShader(c,b);a.attachShader(c,d);a.linkProgram(c);if(!a.getProgramParameter(c,a.LINK_STATUS))throw"Unable to compile the shader program: "+
a.getProgramInfoLog(c);a.useProgram(c);return c},rotation=(a,b)=>{a=mat4.fromYRotation(mat4.create(),4*a);return mat4.multiply(mat4.create(),mat4.fromXRotation(mat4.create(),4*b),a)},mouseMove=(a,b)=>{if(b.dragging){var d=rotation((a.pageX-b.lastX)/b.canvas.width,-(a.pageY-b.lastY)/b.canvas.height),c=mat4.multiply(mat4.create(),b.Tinv,b.modelMatrix);c=mat4.multiply(mat4.create(),d,c);mat4.multiply(b.modelMatrix,b.T,c);b.draw();b.lastX=a.pageX;b.lastY=a.pageY}},mouseDown=(a,b)=>{b.dragging=!0;b.lastX=
a.pageX;b.lastY=a.pageY},mouseUp=(a,b)=>{b.dragging=!1},mouseWheel=(a,b)=>{a.preventDefault();let d=1;0<a.deltaY?d=.9:0>a.deltaY&&(d=1.1);a=vec3.create();vec3.subtract(a,b.eye,b.center);vec3.scaleAndAdd(b.eye,b.center,a,d);mat4.lookAt(b.viewMatrix,b.eye,b.center,vec3.fromValues(0,1,0));b.draw()},computeNormals=(a,b)=>{const d=a.length/3;var c=b.length/3;valency=new Uint8Array(d);normals=new Float32Array(a.length);for(let g=0;g<c;g++){var e=b[3*g];const k=b[3*g+1],l=b[3*g+2];var f=a.slice(3*e,3*e+
3),h=a.slice(3*k,3*k+3);const n=a.slice(3*l,3*l+3);h=vec3.subtract(vec3.create(),h,f);f=vec3.subtract(vec3.create(),n,f);f=vec3.normalize(vec3.create(),vec3.cross(vec3.create(),h,f));for(let m of[e,k,l]){for(e=0;3>e;e++)normals[3*m+e]+=f[e];valency[m]++}}for(a=0;a<d;a++){b=normals.slice(3*a,3*a+3);for(c=0;3>c;c++)b[c]/=valency[a];b=vec3.normalize(vec3.create(),b);for(c=0;3>c;c++)normals[3*a+c]=b[c]}return normals},extractEdges=a=>{let b={},d=[];for(let c=0;c<a.length/3;c++)for(let e=0;3>e;e++){let f=
a[3*c+e],h=a[3*c+(e+1)%3],g=JSON.stringify([Math.min(f,h),Math.max(f,h)]);g in b||(b[g]=d.length/2,d.push(f,h))}return d};
class Renderer{constructor(a){this.canvas=document.getElementById(a);this.gl=this.canvas.getContext("webgl")||this.canvas.getContext("webgl");this.canvas.getContext("experimental-webgl");this.gl.viewport(0,0,this.canvas.width,this.canvas.height);this.gl.getExtension("OES_element_index_uint");this.program=compileProgram(this.gl,"\n      attribute vec3 ap;\n      attribute vec3 an;\n      uniform mat4 umv;\n      uniform mat4 un;\n      uniform mat4 umvp;\n      varying vec3 vn;\n      varying vec3 vp;\n      void main() {\n        gl_Position  = umvp * vec4(ap, 0.6);\n        vn = mat3(un) * an;\n        vp = (umv * vec4(ap, 1.0)).xyz;\n      }","\n      precision highp float;\n      varying vec3 vn;\n      varying vec3 vp;\n      uniform float ue;\n      void main() {\n        vec3 n = normalize(vn);\n        float a = max(0.0, dot(-normalize(vp), n));\n        float b = pow(max(0.1, dot(-reflect(-normalize(vp), n), n)), 32.0);\n        gl_FragColor = (1.0 - ue) * vec4(vec3(0.1) + a * vec3(0.4) + b * vec3(1.9), 1.0) + ue * vec4(1, 0, 0, 1);\n      }");
this.eye=vec3.fromValues(0,0,-5);this.lookat(vec3.create());this.projectionMatrix=mat4.create();this.modelMatrix=mat4.create();mat4.perspective(this.projectionMatrix,Math.PI/4,this.canvas.width/this.canvas.height,.1,1E3);this.dragging=!1;let b=this;this.canvas.addEventListener("mousemove",d=>{mouseMove(d,b)});this.canvas.addEventListener("mousedown",d=>{mouseDown(d,b)});this.canvas.addEventListener("mouseup",d=>{mouseUp(d,b)});this.canvas.addEventListener("mousewheel",d=>{mouseWheel(d,b)})}write(a){let b=
this.gl;var d=vec3.create();for(var c=0;c<a.vertices.length/3;c++)for(let e=0;3>e;e++)d[e]+=a.vertices[3*c+e];for(c=0;3>c;c++)d[c]*=3/a.vertices.length;this.lookat(d);this.T=mat4.fromTranslation(mat4.create(),d);this.Tinv=mat4.invert(mat4.create(),this.T);this.vertexBuffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,this.vertexBuffer);b.bufferData(b.ARRAY_BUFFER,new Float32Array(a.vertices),b.STATIC_DRAW);d=computeNormals(a.vertices,a.triangles);this.normalBuffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,
this.normalBuffer);b.bufferData(b.ARRAY_BUFFER,new Float32Array(d),b.STATIC_DRAW);a.edges=extractEdges(a.triangles);this.edgeBuffer=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.edgeBuffer);b.bufferData(b.ELEMENT_ARRAY_BUFFER,new Uint32Array(a.edges),b.STATIC_DRAW);this.triangleBuffer=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.triangleBuffer);b.bufferData(b.ELEMENT_ARRAY_BUFFER,new Uint32Array(a.triangles),b.STATIC_DRAW);this.mesh=a}lookat(a){this.center=a;this.viewMatrix=
mat4.create();mat4.lookAt(this.viewMatrix,this.eye,this.center,vec3.fromValues(0,1,0))}draw(){let a=this.gl;a.useProgram(this.program);a.clearColor(1,1,1,1);a.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);a.enable(a.DEPTH_TEST);a.enable(a.CULL_FACE);a.enable(a.POLYGON_OFFSET_FILL);a.polygonOffset(2,3);var b=mat4.multiply(mat4.create(),this.viewMatrix,this.modelMatrix);let d=mat4.multiply(mat4.create(),this.projectionMatrix,b),c=mat4.transpose(mat4.create(),mat4.invert(mat4.create(),b));
a.uniformMatrix4fv(a.getUniformLocation(this.program,"umvp"),!1,d);a.uniformMatrix4fv(a.getUniformLocation(this.program,"umv"),!1,b);a.uniformMatrix4fv(a.getUniformLocation(this.program,"un"),!1,c);a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer);b=a.getAttribLocation(this.program,"ap");a.vertexAttribPointer(b,3,a.FLOAT,!1,0,0);a.enableVertexAttribArray(b);a.bindBuffer(a.ARRAY_BUFFER,this.normalBuffer);b=a.getAttribLocation(this.program,"an");a.vertexAttribPointer(b,3,a.FLOAT,!1,0,0);a.enableVertexAttribArray(b);
b=a.getUniformLocation(this.program,"ue");a.uniform1f(b,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.triangleBuffer);a.drawElements(a.TRIANGLES,this.mesh.triangles.length,a.UNSIGNED_INT,0);a.uniform1f(b,1);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.edgeBuffer);document.getElementById("edges-checkbox").checked&&a.drawElements(a.LINES,this.mesh.edges.length,a.UNSIGNED_INT,0)}};
